name: Create Release

# Trigger when a tag is pushed (e.g., v1.0.1, v1.0.2)
on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get tag name
        id: tag
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Extract version from tag
        id: version
        run: |
          TAG=${{ steps.tag.outputs.tag }}
          VERSION=${TAG#v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Extract release notes for this version
        id: release_notes
        run: |
          VERSION=${{ steps.version.outputs.version }}
          
          # Extract the section for this version from RELEASE_NOTES.md
          # This will get everything between "## Version X.X.X" and the next "## Version" or "---"
          awk -v ver="$VERSION" '
            /^## Version / {
              if ($3 == ver || $3 == ver" ") {
                found=1;
                next;
              } else if (found) {
                exit;
              }
            }
            found && /^---$/ { exit }
            found && /^## Version / { exit }
            found { print }
          ' RELEASE_NOTES.md > release_notes_temp.md
          
          # If no specific notes found, use a default message
          if [ ! -s release_notes_temp.md ]; then
            echo "Release version $VERSION" > release_notes_temp.md
            echo "" >> release_notes_temp.md
            echo "See [RELEASE_NOTES.md](RELEASE_NOTES.md) for details." >> release_notes_temp.md
          fi
          
          cat release_notes_temp.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Release ${{ steps.tag.outputs.tag }}
          body_path: release_notes_temp.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload release notes as artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-notes-${{ steps.version.outputs.version }}
          path: release_notes_temp.md
          retention-days: 90

  # Build artifacts job is commented out - uncomment when you have EAS credentials
  # See RELEASE_GUIDE.md for instructions on setting up automated builds
  
  # build-artifacts:
  #   name: Build Release Artifacts
  #   needs: create-release
  #   runs-on: ubuntu-latest
  #   
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '20'
  #         cache: 'npm'
  #
  #     - name: Install dependencies
  #       run: npm ci
  #
  #     - name: Setup EAS
  #       uses: expo/expo-github-action@v8
  #       with:
  #         eas-version: latest
  #         token: ${{ secrets.EXPO_TOKEN }}
  #
  #     - name: Build Android APK
  #       run: eas build --platform android --profile preview --non-interactive
  #
  #     - name: Upload APK to release
  #       if: success()
  #       uses: softprops/action-gh-release@v1
  #       with:
  #         tag_name: ${{ github.ref_name }}
  #         files: '*.apk'
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
